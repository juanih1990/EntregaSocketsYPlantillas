<div>
    {{!-- <h1> Productos desde de FleSystem</h1>
    {{#each products }}
    <hr>
    <ul>
        <li>{{this.title}}</li>
        <li><span>{{this.price}}</span></li>
    </ul>
    <hr>
    {{/each}}
</div> --}}

<div>
    {{#if result.Productos}}
    <h1> Productos de base da datos Mongo </h1>
    {{#each result.Productos}}
    <hr>
    <ul>
        <li><span>Producto: {{this.title}}</span></li>
        <li><span>Precio: {{this.price}}</span></li>
        <li><span>Stock: {{this.stock}}</span></li>
        <hr>
        <button class="delete" data-product-id="{{this._id}}">Delete</button>
        <button class="add" data-cart-id="{{this._id}}">Agregar al carrito</button>
    </ul>
    <hr>
    {{/each}}

    <span>Total Products:</span> {{ result.totalDocs }} <br>
    <span>pages:</span> {{ result.page }} / {{ result.totalPages }} <br>
    <span>Limit: </span> <input id="limit" type="text" value="{{result.limit}}"><br>
    <span>Page: </span> <input id="page" type="text" value="{{result.page}}"><br>
    <span>Query: </span> <input type="text" value="{{result.query}}" id="query"><br><br>


    <label for="sortField">Ordenar por:</label>
    <select id="sortField" name="sortField">
        <option value="title">Nombre</option>
        <option value="price">Precio</option>
    </select>

    <label for="sortOrder">Orden:</label>
    <select id="sortOrder" name="sortOrder">
        <option value="asc">Menor a mayor</option>
        <option value="desc">Mayor a menor</option>
    </select><br><br>

    <label for="category">Categoría:</label>
    <select id="category" name="category">
        <option value="">Todos</option>
        <option value="Audio">Audio</option>
        <option value="Periferico">Periférico</option>
        <option value="Notebook">Notebook</option>
        <option value="Display">Display</option>
    </select>

    <label for="stockOnly">Mostrar solo productos disponibles:</label>
    <input type="checkbox" id="stockOnly" name="stockOnly"><br><br>



    <button id="btnSearch">Buscar</button><br><br>

    <input id="prevPage" type="hidden" value="{{result.prevPage}}">
    <input id="nextPage" type="hidden" value="{{result.nextPage}}">

    <a id="btnPrev" href="#" {{#unless result.hasPrevPage}} style="display: none" {{/unless}}> Anterior </a>
    <a id="btnNext" href="#" {{#unless result.hasNextPage}} style="display: none" {{/unless}}> Siguiente </a><br>

    {{/if}}
</div>


<script>

    const deleteButtons = document.querySelectorAll('.delete')
    deleteButtons.forEach(button => {
        button.onclick = e => {
            const id = button.dataset.productId;
            fetch(`/productos/${id}`, { method: 'delete' })
                .then(() => {
                    alert('Eliminado con éxito' + id);
                    document.location.href = '/productos'
                    console.log(id);
                })
                .catch(e => {
                    alert('No se puede eliminar el producto')
                });
        };
    });



    const addToCart = document.querySelectorAll('.add')
    addToCart.forEach(button => {
        button.onclick = e => {
            const id = button.dataset.cartId;
            fetch(`/productos/${id}`, { method: 'post' })
                .then(() => {
                    alert('Se agrego el producto' + id + " al carrito")
                    document.location.href = '/productos'
                })
                .catch(e => {
                    alert(e)
                });
        };
    });

    document.querySelector('#btnPrev').onclick = () => {
        const prevPage = document.querySelector('#prevPage').value
        const limit = document.querySelector('#limit').value
        const query = document.querySelector('#query').value
        const sortField = document.querySelector('#sortField').value
        const sortOrder = document.querySelector('#sortOrder').value
        const category = document.querySelector('#category').value
        const stockOnly = document.querySelector('#stockOnly').checked

        let url = `http://localhost:8080/productos?page=${parseInt(prevPage)}&limit=${limit}&query=${query}&sort=${sortField}&order=${sortOrder}`

        if (category) {
            url += `&category=${category}`
        }

        if (stockOnly) {
            url += '&stockOnly=true'
        }

        document.location.href = url
    }

    document.querySelector('#btnNext').onclick = () => {
        const nextPage = document.querySelector('#nextPage').value
        const limit = document.querySelector('#limit').value
        const query = document.querySelector('#query').value
        const sortField = document.querySelector('#sortField').value
        const sortOrder = document.querySelector('#sortOrder').value
        const category = document.querySelector('#category').value
        const stockOnly = document.querySelector('#stockOnly').checked

        let url = `http://localhost:8080/productos?page=${parseInt(nextPage)}&limit=${limit}&query=${query}&sort=${sortField}&order=${sortOrder}`;

        if (category) {
            url += `&category=${category}`
        }

        if (stockOnly) {
            url += '&stockOnly=true'
        }

        document.location.href = url
    }

    document.querySelector("#btnSearch").onclick = () => {
        const page = document.querySelector('#page').value
        const limit = document.querySelector('#limit').value
        const query = document.querySelector('#query').value
        const sortField = document.querySelector('#sortField').value
        const sortOrder = document.querySelector('#sortOrder').value
        const category = document.querySelector('#category').value;
        const stockOnly = document.querySelector('#stockOnly').checked;

        let url = `http://localhost:8080/productos?page=${page}&limit=${limit}&query=${query}&sort=${sortField}&order=${sortOrder}`

        if (category) {
            url += `&category=${category}`
        }

        if (stockOnly) {
            url += '&stockOnly=true'
        }

        document.location.href = url
    }
</script>